name: Deploy to Windows VM

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0

    - name: Restore dependencies
      run: dotnet restore

    - name: Build the project
      run: dotnet publish -c Release -o ./publish

    - name: Write SSH Key to File
      shell: pwsh
      run: |
        $privateKeyPath = "$env:GITHUB_WORKSPACE\id_rsa"
        Set-Content -Path $privateKeyPath -Value "${{ secrets.AZURE_VM_PRIVATE_KEY }}" -NoNewline

    - name: Copy files to Windows VM using SCP
      shell: pwsh
      run: |
        $sourcePath = "./publish/*"
        $destinationPath = "C:/inetpub/wwwroot/LibraryApp"
        $vmHost = "${{ secrets.AZURE_VM_IP }}"
        $vmUsername = "${{ secrets.AZURE_VM_USER }}"
        $privateKeyPath = "$env:GITHUB_WORKSPACE\id_rsa"
        $port = 22

        # Create an SSH session
        $session = New-PSSession -HostName $vmHost -UserName $vmUsername -KeyFile $privateKeyPath -Port $port

        # Copy files using SCP
        Copy-Item -ToSession $session -Path $sourcePath -Destination $destinationPath -Recurse

    - name: Restart IIS
      shell: pwsh
      run: |
        $vmHost = "${{ secrets.AZURE_VM_IP }}"
        $vmUsername = "${{ secrets.AZURE_VM_USER }}"
        $privateKeyPath = "$env:GITHUB_WORKSPACE\id_rsa"
        $port = 22

        # Restart IIS using SSH
        ssh -i $privateKeyPath -p $port $vmUsername@$vmHost "iisreset"
